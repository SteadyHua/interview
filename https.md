# HTTPS

## HTTPS四次握手

整个过程是明文的

![HTTPS四次握手](https://tva1.sinaimg.cn/large/00831rSTly1gcdn16pgkbj30g40erwem.jpg)

1. 客户端发出请求：ClientHello
   > 支持的协议版本，比如TLS 1.0版。
   > 一个客户端生成的随机数，稍后用于生成"对话密钥"。
   > 支持的加密方法，比如RSA公钥加密。
   > 支持的压缩方法。

2. 服务器回应：ServerHello
   >  确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
   >  一个服务器生成的随机数，稍后用于生成"对话密钥"。
   >  确认使用的加密方法，比如RSA公钥加密。
   >  服务器证书。

   除了上面这些信息，如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供"客户端证书"。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。
   
3. 客户端回应

   1. 验证证书

   2. 取出服务器公钥

   3. 发送信息

      > 一个随机数。该随机数用服务器公钥加密，防止被窃听。
      >
      > 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
      >
      > 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

      至此为止，共有3个随机数；服务器端和客户端会各自用这3个随机数以及在第2步中确定的加密方法，生成同一把“会话密钥”

4. 服务器的最后回应

   > 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
   >
   > 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

   至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，就完全是使用普通的HTTP协议，只不过用"会话密钥"加密内容。



## HTTPS 中间人攻击

中间人攻击过程如下：

1. 服务器向客户端发送公钥。
2. 攻击者截获公钥，保留在自己手上。
3. 然后攻击者自己生成一个【伪造的】公钥，发给客户端。
4. 客户端收到伪造的公钥后，生成加密hash值发给服务器。
5. 攻击者获得加密hash值，用自己的私钥解密获得真秘钥。
6. 同时生成假的加密hash值，发给服务器。
7. 服务器用私钥解密获得假秘钥。
8. 服务器用加秘钥加密传输信息

防范方法：

1. 服务端在发送浏览器的公钥中加入CA证书，浏览器可以验证CA证书的有效性